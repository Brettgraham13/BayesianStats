{
    "collab_server" : "",
    "contents" : "---\ntitle: \"Scraping\"\nauthor: \"Brett Graham & Gunnar Goeden\"\ndate: \"11/8/2017\"\noutput: html_document\n---\n\n### Notes:\nNeed NFL game score data as follows:\\\nweek number, home/away teams, scores, rushing yards, rushing attempts, rushing td, rushing fumbles, passing yards, passing TD, passing attempts, passing completions.\n\n```{r}\nlibrary(xml2)\nlibrary(rvest)\nlibrary(tidyr)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(lubridate)\n```\n\n\nhttps://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf\n\n#Questions:\nHow to split numeric values scraped as \"x-y-z\" ?\nHow to incorporate week into data table? (ie. How to say \"all dates from 9/10/15 to 9/14/15 = week 1\")\n\n##2015 Team & Score Data (first webpage)\n```{r}\nurl2015 <- 'http://www.footballdb.com/games/index.html?lg=NFL&yr=2015'\nwebpage2015 <- read_html(url2015)\n\ndate15_html <- html_nodes(webpage2015,'td:nth-child(1) .hidden-xs')\ndate15_data <- html_text(date15_html)\n\nvisitteam15_html <- html_nodes(webpage2015,'td:nth-child(2) .hidden-xs')\nvisitteam15_data <- html_text(visitteam15_html)\n\nvisitscore15_html <- html_nodes(webpage2015,'#leftcol .center:nth-child(3)')\nvisitscore15_data <- html_text(visitscore15_html)\nvisitscore15_data <-as.numeric(visitscore15_data)\n\nhometeam15_html <- html_nodes(webpage2015,'.center+ td > .hidden-xs')\nhometeam15_data <- html_text(hometeam15_html)\n\nhomescore15_html <- html_nodes(webpage2015,'.center:nth-child(5)')\nhomescore15_data <- html_text(homescore15_html)\nhomescore15_data <-as.numeric(homescore15_data)\n\nfbscores2015 <- data.frame(Date = date15_data, Visiting_Team = visitteam15_data, Visiting_Score = visitscore15_data, Home_Team = hometeam15_data, Home_Score = homescore15_data)\n#fbscores2015\n```\n\n##2016 Team & Score Data \n```{r}\nurl2016 <- 'http://www.footballdb.com/games/index.html?lg=NFL&yr=2016'\nwebpage2016 <- read_html(url2016)\n\ndate16_html <- html_nodes(webpage2016,'td:nth-child(1) .hidden-xs')\ndate16_data <- html_text(date16_html)\n\nvisitteam16_html <- html_nodes(webpage2016,'td:nth-child(2) .hidden-xs')\nvisitteam16_data <- html_text(visitteam16_html)\n\nvisitscore16_html <- html_nodes(webpage2016,'#leftcol .center:nth-child(3)')\nvisitscore16_data <- html_text(visitscore16_html)\nvisitscore16_data <-as.numeric(visitscore16_data)\n\nhometeam16_html <- html_nodes(webpage2016,'.center+ td > .hidden-xs')\nhometeam16_data <- html_text(hometeam16_html)\n\nhomescore16_html <- html_nodes(webpage2016,'.center:nth-child(5)')\nhomescore16_data <- html_text(homescore16_html)\nhomescore16_data <-as.numeric(homescore16_data)\n\nfbscores2016 <- data.frame(Date = date16_data, Visiting_Team = visitteam16_data, Visiting_Score = visitscore16_data, Home_Team = hometeam16_data, Home_Score = homescore16_data)\n#fbscores2016\n```\n\n##2017 Team & Score Data \n```{r}\nurl2017 <- 'http://www.footballdb.com/games/index.html?lg=NFL&yr=2017'\nwebpage2017 <- read_html(url2017)\n\ndate17_html <- html_nodes(webpage2017,'td:nth-child(1) .hidden-xs')\ndate17_data <- html_text(date17_html)\ndate17_data <- as.Date(date17_data,\"%m/%d/%Y\")\n\nvisitteam17_html <- html_nodes(webpage2017,'td:nth-child(2) .hidden-xs')\nvisitteam17_data <- html_text(visitteam17_html)\n\nvisitscore17_html <- html_nodes(webpage2017,'#leftcol .center:nth-child(3)')\nvisitscore17_data <- html_text(visitscore17_html)\nvisitscore17_data <-as.numeric(visitscore17_data)\n\nhometeam17_html <- html_nodes(webpage2017,'.center+ td > .hidden-xs')\nhometeam17_data <- html_text(hometeam17_html)\n\nhomescore17_html <- html_nodes(webpage2017,'.center:nth-child(5)')\nhomescore17_data <- html_text(homescore17_html)\nhomescore17_data <-as.numeric(homescore17_data)\n\nfbscores2017 <- data.frame(Date = date17_data, Visiting_Team = visitteam17_data, Visiting_Score = visitscore17_data, Home_Team = hometeam17_data, Home_Score = homescore17_data)\n#fbscores2017\n```\n\n```{r}\ndate_html <- html_nodes(webpage2017,'td:nth-child(1) .hidden-xs , .divheader')\ndate_data <- html_text(date_html)\n#date_data\n\nweek <- rep(0,256)\nif (date17_data >= \"2017-09-14\") week=1 else week=0\nmutate(fbscores2017, Week=week)\n\n#date17_data\n#week <- rep(0,50)\n\n```\n\n\n```{r}\nurl <- \"http://www.footballdb.com/games/boxscore.html?gid=2017091001\"\n\n#Reading the HTML code from the website\nwebpage <- read_html(url)\n\ntitle_data_html <- html_nodes(webpage,\"#divBox_team tbody .left\")\ntitle_data <- html_text(title_data_html)\ntitle_data <- append(c(\"Team\", \"Points\"), title_data)\n\n# #Create boxscore \n# boxscore <- data.frame(Category = title_data, Home = home_data, Away = away_data)\n\n#Create game event (single row that describes game)\nhome_variables <- paste0(rep(\"Home_\",length(title_data)),title_data)\naway_variables <- paste0(rep(\"Away_\",length(title_data)),title_data)\nevent_variables <- append(home_variables,away_variables)\nevent_variables <- append(c(\"Date\",\"Week\"),event_variables)\n\nlength(event_variables)\n\n```\n\n```{r}\ncreateDateVector <- function(year){\n  url <- paste0('http://www.footballdb.com/games/index.html?lg=NFL&yr=',toString(year))\n  webpage <- read_html(url)\n  date_html <- html_nodes(webpage,'td:nth-child(1) .hidden-xs')\n  date_data <- html_text(date_html)\n  dateVect <- as.Date(date_data,\"%m/%d/%Y\")\n  \n  today = today()\n  daysBeforeToday = dateVect <= today\n  dateVect = dateVect[daysBeforeToday]\n}\n```\n\n```{r}\ndateToURL <- function(dateVect, i, adjustment=0){\n  url_base <- 'http://www.footballdb.com/games/boxscore.html?gid='\n  url_year = year(dateVect[i])\n  if(month(dateVect[i])<10){\n    url_month <- paste0(\"0\",month(dateVect[i]))\n  }else{\n    (url_month <-toString(month(dateVect[i])))\n   }\n  if(day(dateVect[i])<10){\n    url_day <- paste0(\"0\",day(dateVect[i]))\n  }else{\n    url_day <-toString(day(dateVect[i]))\n  }\n  \n  gameNum = 1\n  location = i-1\n  if(location >0){\n    while(dateVect[i]==dateVect[location]){\n      gameNum = gameNum+1\n      location=location-1\n      \n      if(location==0){\n        break\n      }\n    }\n  }\n  \n  gameNum = gameNum + adjustment\n  \n  if(gameNum<10){\n    url_gamenum <- paste0(\"0\",toString(gameNum))\n  }else{\n    url_gamenum <-toString(gameNum)\n  }\n\n  url <- paste0(url_base,url_year,url_month,url_day,toString(url_gamenum))\n\n  \n  return(list(url=url,url_year=url_year,url_month = url_month,url_day=url_day))\n}\n```\n```{r}\nyearlyStats <- function(dateVect){\n  data = matrix(rep('',length(event_variables)),nrow=1)\n  \n  for(i in 1:length(dateVect)){\n\n\n    url_info <- dateToURL(dateVect,i)\n    url <- url_info$url\n    \n    webpage <- read_html(url)\n  \n  \n    away_data_html <- html_nodes(webpage,'#divBox_team .row1 .left+ td , .section_left .left+ td .hidden-xs , #divBox_team .row0 .left+ td')\n    away_data <- html_text(away_data_html)\n    away_points <- html_text(html_nodes(webpage,'#leftcol .header+ .center td+ td b'))\n    away_data <- append(away_data,away_points, after = 1)\n  \n    home_data_html <- html_nodes(webpage,\"#divBox_team .row1 .left~ td+ td , #divBox_team .row0 .left~ td+ td , .section_left .left~ td+ td .hidden-xs\")\n    home_data <- html_text(home_data_html)\n    home_points <- html_text(html_nodes(webpage,'#leftcol .row0+ .center td+ td b'))\n    home_data <- append(home_data,home_points, after = 1)\n    \n    week_info <- html_text(html_nodes(webpage,'#breadcrumbs a~ a+ a'))\n  \n    date = paste0(url_info$url_month,\"/\",url_info$url_day,\"/\",url_info$url_year)\n    date = append(date,week_info)\n    game_data = append(date,home_data)\n    game_data = append(game_data,away_data)\n    \n    \n    \n    adjustment = 1\n    while(length(game_data)==2 |length(game_data)==1){\n      url <- dateToURL(dateVect,i,adjustment = adjustment)$url\n    \n      webpage <- read_html(url)\n    \n      away_data_html <- html_nodes(webpage,'#divBox_team .row1 .left+ td , .section_left .left+ td .hidden-xs , #divBox_team .row0 .left+ td')\n      away_data <- html_text(away_data_html)\n      away_points <- html_text(html_nodes(webpage,'#leftcol .header+ .center td+ td b'))\n      away_data <- append(away_data,away_points, after = 1)\n    \n      home_data_html <- html_nodes(webpage,\"#divBox_team .row1 .left~ td+ td , #divBox_team .row0 .left~ td+ td , .section_left .left~ td+ td .hidden-xs\")\n      home_data <- html_text(home_data_html)\n      home_points <- html_text(html_nodes(webpage,'#leftcol .row0+ .center td+ td b'))\n      home_data <- append(home_data,home_points, after = 1)\n      \n      week_info <- html_text(html_nodes(webpage,'#breadcrumbs a~ a+ a'))\n\n    \n      date = paste0(url_info$url_month,\"/\",url_info$url_day,\"/\",url_info$url_year)\n      date = append(date,week_info)\n      game_data = append(date,home_data)\n      game_data = append(game_data,away_data)\n    \n      adjustment = adjustment+1\n    \n    \n      if(adjustment >100){\n        print(\"ERROR: ADJUSTMENT TOO LARGE\")\n        print(i)\n        break\n      }\n  \n    }\n    data = rbind(data,game_data)\n  \n  }\n  return(data)\n}\n```\n```{r}\ncreateDataframe <- function(year){\n  dateVect = createDateVector(year)\n  data_mat = yearlyStats(dateVect)\n  data_mat = data_mat[-1,]\n  game_stats <- data.frame(data_mat)\n  names(game_stats)[1:length(event_variables)] <- event_variables\n  names(game_stats)[c(12,40)] <- c('Home_Avg Rush Gain','Away_Avg Rush Gain')\n  return(game_stats)\n    \n}\n```\n```{r}\ncreatePredictionsDataFrame <- function(year){\n  url <- paste0('http://www.footballdb.com/games/index.html?lg=NFL&yr=',year)\n  webpage <- read_html(url)\n  \n  date_html <- html_nodes(webpage,'td:nth-child(1) .hidden-xs')\n  date_data <- html_text(date_html)\n  date_data <- as.Date(date_data,\"%m/%d/%Y\")\n  \n  visitteam_html <- html_nodes(webpage,'td:nth-child(2) .hidden-xs')\n  visitteam_data <- html_text(visitteam_html)\n  \n  visitscore_html <- html_nodes(webpage,'#leftcol .center:nth-child(3)')\n  visitscore_data <- html_text(visitscore_html)\n  visitscore_data <-as.numeric(visitscore_data)\n  \n  hometeam_html <- html_nodes(webpage,'.center+ td > .hidden-xs')\n  hometeam_data <- html_text(hometeam_html)\n  \n  homescore_html <- html_nodes(webpage,'.center:nth-child(5)')\n  homescore_data <- html_text(homescore_html)\n  homescore_data <-as.numeric(homescore_data)\n  \n  fbscores <- data.frame(Date = date_data, Home_Team = hometeam17_data, Home_Points = homescore17_data, Away_Team = visitteam17_data, Away_Points = visitscore17_data)\n  \n  return(fbscores)\n  \n}\n\n# View(createPredictionsDataFrame(2017))\n\n\n\n```\n\n\n```{r}\n# game_stats_2010 <- createDataframe(2010)\n# game_stats_2010<- game_stats_2010[-c(208,240),]\n# game_stats_2011 <- createDataframe(2011)\n# game_stats_2012 <- createDataframe(2012)\n# game_stats_2013 <- createDataframe(2013)\n# game_stats_2014 <- createDataframe(2014)\n# game_stats_2014<- game_stats_2014[-176,]\n# game_stats_2015 <- createDataframe(2015)\n# game_stats_2016 <- createDataframe(2016)\ngame_stats_2017 <- createDataframe(2017)\ngame_stats_2017 <- game_stats_2017[-159,]\n\n\nView(game_stats_2017)\n```\n\n\n\n\n\n\n",
    "created" : 1519876870260.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "637829607",
    "id" : "1A6AEA2A",
    "lastKnownWriteTime" : 1519713674,
    "last_content_update" : 1519713674,
    "path" : "~/BayesStats_Project/Scraping.Rmd",
    "project_path" : "Scraping.Rmd",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}